{% extends "base.html" %}
{% block title %}Import - LL Trivia{% endblock %}

{% block content %}
<h1>Import Questions</h1>

<div class="import-layout">
    <div class="import-form-card">
        <h2>Scrape from LearnedLeague</h2>
        <form id="scrape-form">
            <div class="form-group">
                <label for="username">LL Username</label>
                <input type="text" id="username" name="username" placeholder="From env var if set">
            </div>
            <div class="form-group">
                <label for="password">LL Password</label>
                <input type="password" id="password" name="password" placeholder="From env var if set">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="start_season">Start Season</label>
                    <input type="number" id="start_season" name="start_season" value="88" min="1" required>
                </div>
                <div class="form-group">
                    <label for="end_season">End Season</label>
                    <input type="number" id="end_season" name="end_season" value="88" min="1" required>
                </div>
            </div>
            <p class="form-help">Each season has 25 match days with 6 questions each (150 questions/season).</p>
            <button type="submit" class="btn btn-primary" id="scrape-btn">Start Scraping</button>
        </form>
    </div>

    <div class="import-log-card">
        <h2>Progress</h2>
        <div class="log-area" id="log-area">
            <p class="log-placeholder">Scrape progress will appear here...</p>
        </div>
        <div id="scrape-result" style="display:none"></div>
    </div>
</div>

<script>
const form = document.getElementById('scrape-form');
const logArea = document.getElementById('log-area');
const scrapeBtn = document.getElementById('scrape-btn');
const scrapeResult = document.getElementById('scrape-result');
let pollInterval = null;

form.addEventListener('submit', async (e) => {
    e.preventDefault();
    scrapeBtn.disabled = true;
    scrapeBtn.textContent = 'Scraping...';
    logArea.innerHTML = '';
    scrapeResult.style.display = 'none';

    const formData = new FormData(form);

    try {
        const resp = await fetch('/import/scrape', { method: 'POST', body: formData });
        const data = await resp.json();
        if (data.error) {
            logArea.innerHTML = '<p class="log-error">' + data.error + '</p>';
            scrapeBtn.disabled = false;
            scrapeBtn.textContent = 'Start Scraping';
            return;
        }
        // Start polling for status
        pollInterval = setInterval(pollStatus, 2000);
    } catch (err) {
        logArea.innerHTML = '<p class="log-error">Request failed: ' + err.message + '</p>';
        scrapeBtn.disabled = false;
        scrapeBtn.textContent = 'Start Scraping';
    }
});

async function pollStatus() {
    try {
        const resp = await fetch('/import/status');
        const data = await resp.json();

        logArea.innerHTML = data.messages
            .map(m => '<div class="log-line">' + escapeHtml(m) + '</div>')
            .join('');
        logArea.scrollTop = logArea.scrollHeight;

        if (!data.running) {
            clearInterval(pollInterval);
            scrapeBtn.disabled = false;
            scrapeBtn.textContent = 'Start Scraping';

            if (data.result) {
                if (data.result.error) {
                    scrapeResult.innerHTML = '<div class="result-error">Error: ' + escapeHtml(data.result.error) + '</div>';
                } else {
                    scrapeResult.innerHTML =
                        '<div class="result-success">' +
                        'Saved: ' + data.result.total_saved +
                        ' | Skipped (duplicates): ' + data.result.total_skipped +
                        ' | Errors: ' + data.result.errors.length +
                        '</div>';
                }
                scrapeResult.style.display = 'block';
            }
        }
    } catch (err) {
        // ignore transient fetch errors during polling
    }
}

function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}
</script>
{% endblock %}
